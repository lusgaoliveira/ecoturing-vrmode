<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Visualiza√ß√£o 360¬∞ VR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: black;
    }

    #enter-vr-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 12px 18px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      cursor: pointer;
      display: none;
      z-index: 999;
    }

    #vr-fake {
      display: none;
      position: fixed;
      top:0; left:0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
      overflow: hidden;
      background:black;
    }

    #vr-left, #vr-right {
      position:absolute;
      top:0; height:100%; width:50%;
      overflow:hidden;
    }
    #vr-right { left:50%; }

    canvas { display:block; }
  </style>
</head>
<body>

<a-scene id="scene" vr-mode-ui="enabled:true">
  <a-assets>
    <img id="panorama" src="./Cantagalo.JPG" crossorigin="anonymous">

    <!-- panoramas temp -->
    <img id="temp1" src="./Cantagalo.JPG" crossorigin="anonymous">
    <img id="temp2" src="./Q360_20240713_135032_000001_Output.JPG" crossorigin="anonymous">

    <!-- √°udios temp -->
    <audio id="audio1" src="./tes1.mp3" preload="auto"></audio>
    <audio id="audio2" src="./tes2.mp3" preload="auto"></audio>
  </a-assets>

  <a-entity id="rig" position="0 1.6 0">
    <a-camera look-controls="true" wasd-controls-enabled="false"></a-camera>
  </a-entity>

  <!-- panorama principal -->
  <a-sky id="sky" src="#panorama" rotation="0 -90 0" visible="false"></a-sky>

  <!-- panorama tempor√°rio que vai ficar trocando -->
  <a-sky id="sky-temp" src="#temp1" rotation="0 -90 0" visible="false"></a-sky>
</a-scene>

<button id="enter-vr-btn">üï∂Ô∏è Ativar VR</button>

<div id="vr-fake">
  <canvas id="vr-left"></canvas>
  <canvas id="vr-right"></canvas>
</div>

<script>
window.addEventListener("load", () => {
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const btn = document.getElementById("enter-vr-btn");
  const scene = document.getElementById("scene");
  const sky = document.getElementById("sky");
  const skyTemp = document.getElementById("sky-temp");
  const vrFake = document.getElementById("vr-fake");

  if(isIOS) btn.style.display = "block";

  scene.addEventListener("loaded", () => {
    const panorama = document.getElementById("panorama");
    if(panorama.complete){
      sky.setAttribute("visible", "true");
    } else {
      panorama.addEventListener("load", () => {
        sky.setAttribute("visible","true");
      });
    }
  });

  async function requestSensorPermissions(){
    if(typeof DeviceMotionEvent?.requestPermission === "function"){
      try { await DeviceMotionEvent.requestPermission(); } catch {}
    }
    if(typeof DeviceOrientationEvent?.requestPermission === "function"){
      try { await DeviceOrientationEvent.requestPermission(); } catch {}
    }
  }

  const panoramasTemp = [
    { img: "#temp1", audio: document.getElementById("audio1") },
    { img: "#temp2", audio: document.getElementById("audio2") }
  ];
  let currentTempIndex = 0;

  function playTemporarySequence() {
    if(currentTempIndex >= panoramasTemp.length){
      // Sequ√™ncia acaba n√£o √© mais redenrizada
      skyTemp.setAttribute("visible", "false"); 
      return;
    }

    const pano = panoramasTemp[currentTempIndex];
    skyTemp.setAttribute("src", pano.img);
    skyTemp.setAttribute("visible", "true");
    pano.audio.play();

    // Como vai ser um a√∫dio explicando a trilha provavelmente, vai ser necess√°rio aumentar o tempo e padrozinar a explica√ß√£o
    setTimeout(() => {
      pano.audio.pause();
      pano.audio.currentTime = 0;
      currentTempIndex++;
      playTemporarySequence();
    }, 30000);
  }
  setTimeout(playTemporarySequence, 5000);

  btn.addEventListener("click", async () => {
    await requestSensorPermissions();

    if(isIOS){
      // === iOS VR simulado ===
      vrFake.style.display = "block";
      scene.style.display = "none";

      const canvasLeft = document.getElementById("vr-left");
      const canvasRight = document.getElementById("vr-right");

      canvasLeft.width = window.innerWidth/2;
      canvasLeft.height = window.innerHeight;
      canvasRight.width = window.innerWidth/2;
      canvasRight.height = window.innerHeight;

      const rendererLeft = new THREE.WebGLRenderer({ canvas: canvasLeft });
      const rendererRight = new THREE.WebGLRenderer({ canvas: canvasRight });

      rendererLeft.setSize(window.innerWidth/2, window.innerHeight);
      rendererRight.setSize(window.innerWidth/2, window.innerHeight);

      const scene3D = scene.object3D;
      const cameraLeft = new THREE.PerspectiveCamera(75, (window.innerWidth/2)/window.innerHeight, 0.1, 1000);
      const cameraRight = cameraLeft.clone();

      cameraLeft.position.x = -0.03; 
      cameraRight.position.x = 0.03;

      function applyBarrelDistortion(renderer, canvas){
        const gl = renderer.getContext();
        gl.viewport(0,0,canvas.width,canvas.height);
      }

      function updateCameraFromDeviceOrientation(camera, alpha, beta, gamma){
        const deg2rad = Math.PI/180;
        const euler = new THREE.Euler(beta*deg2rad, alpha*deg2rad, -gamma*deg2rad, 'YXZ');
        camera.quaternion.setFromEuler(euler);
      }

      window.addEventListener("deviceorientation", e => {
        updateCameraFromDeviceOrientation(cameraLeft, e.alpha, e.beta, e.gamma);
        updateCameraFromDeviceOrientation(cameraRight, e.alpha, e.beta, e.gamma);
      });

      function renderLoop(){
        rendererLeft.render(scene3D, cameraLeft);
        rendererRight.render(scene3D, cameraRight);
        requestAnimationFrame(renderLoop);
      }
      renderLoop();

      const el = document.documentElement;
      const reqFS = el.requestFullscreen || el.webkitRequestFullscreen;
      if(reqFS) reqFS.call(el);

    } else {
      // Android
      if(scene && typeof scene.enterVR === "function"){
        try { await scene.enterVR(); } catch(err){ console.warn(err); }
      }
    }
  });

});
</script>

</body>
</html>
